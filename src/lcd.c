#include <string.h>
#include <plib.h>
#include "comm.h"
#include "picsetup.h"
#include "lcd.h"

#define A0             LATBbits.LATB13
#define RST            LATAbits.LATA1
#define SPI_CHANNEL    SPI_CHANNEL1

#define LCD_NUM_PAGES    (4)
#define LCD_NUM_COLS     (128)

#define SET_PAGE_ADDRESS(page)      (0xB0 | (page))
#define SET_COL_ADDRESS_MSB(col)    (0x10 | (col >> 4))
#define SET_COL_ADDRESS_LSB(col)    (0x00 | (col & 0x0F))
#define SET_START_LINE(line)        (0x40 | (line))

#define LCD_DISPLAY_OFF    (0xAE)
#define LCD_DISPLAY_ON     (0xAF)

typedef enum {
        CMD_MODE  = 0,
        DATA_MODE = 1
} LCDCommandMode;

unsigned char characters[][7] = {
        { 0x00,0x00,0x00,0x00,0x00,0x00,0x00 },    // ' '0
        { 0x00,0x06,0x5F,0x5F,0x06,0x00,0x00 },    // '!'1
        { 0x00,0x07,0x07,0x00,0x07,0x07,0x00 },    // '"'2
        { 0x14,0x7F,0x7F,0x14,0x7F,0x7F,0x14 },    // '#'3
        { 0x24,0x2E,0x6B,0x6B,0x3A,0x12,0x00 },    // '$'4
        { 0x46,0x66,0x30,0x18,0x0C,0x66,0x62 },    // '%'5
        { 0x30,0x7A,0x4F,0x5D,0x37,0x7A,0x48 },    // '&'6
        { 0x04,0x07,0x03,0x00,0x00,0x00,0x00 },    // '''7
        { 0x00,0x1C,0x3E,0x63,0x41,0x00,0x00 },    // '('8
        { 0x00,0x41,0x63,0x3E,0x1C,0x00,0x00 },    // ')'9
        { 0x08,0x2A,0x3E,0x1C,0x1C,0x3E,0x2A },    // '*'10
        { 0x08,0x08,0x3E,0x3E,0x08,0x08,0x00 },    // '+'11
        { 0x00,0x80,0xE0,0x60,0x00,0x00,0x00 },    // ','12
        { 0x08,0x08,0x08,0x08,0x08,0x08,0x00 },    // '-'13
        { 0x00,0x00,0x60,0x60,0x00,0x00,0x00 },    // '.'14
        { 0x60,0x30,0x18,0x0C,0x06,0x03,0x01 },    // '/'15
        { 0x3E,0x7F,0x71,0x59,0x4D,0x7F,0x3E },    // '0'16
        { 0x40,0x42,0x7F,0x7F,0x40,0x40,0x00 },    // '1'17
        { 0x62,0x73,0x59,0x49,0x6F,0x66,0x00 },    // '2'18
        { 0x22,0x63,0x49,0x49,0x7F,0x36,0x00 },    // '3'19
        { 0x18,0x1C,0x16,0x53,0x7F,0x7F,0x50 },    // '4'20
        { 0x27,0x67,0x45,0x45,0x7D,0x39,0x00 },    // '5'21
        { 0x3C,0x7E,0x4B,0x49,0x79,0x30,0x00 },    // '6'22
        { 0x03,0x03,0x71,0x79,0x0F,0x07,0x00 },    // '7'23
        { 0x36,0x7F,0x49,0x49,0x7F,0x36,0x00 },    // '8'24
        { 0x06,0x4F,0x49,0x69,0x3F,0x1E,0x00 },    // '9'25
        { 0x00,0x00,0x66,0x66,0x00,0x00,0x00 },    // ':'26
        { 0x00,0x80,0xE6,0x66,0x00,0x00,0x00 },    // ';'27
        { 0x08,0x1C,0x36,0x63,0x41,0x00,0x00 },    // '<'28
        { 0x24,0x24,0x24,0x24,0x24,0x24,0x00 },    // '='29
        { 0x00,0x41,0x63,0x36,0x1C,0x08,0x00 },    // '>'30
        { 0x02,0x03,0x51,0x59,0x0F,0x06,0x00 },    // '?'31
        { 0x3E,0x7F,0x41,0x5D,0x5D,0x1F,0x1E },    // '@'32
        { 0x7C,0x7E,0x13,0x13,0x7E,0x7C,0x00 },    // 'A'33
        { 0x41,0x7F,0x7F,0x49,0x49,0x7F,0x36 },    // 'B'34
        { 0x1C,0x3E,0x63,0x41,0x41,0x63,0x22 },    // 'C'35
        { 0x41,0x7F,0x7F,0x41,0x63,0x3E,0x1C },    // 'D'36
        { 0x41,0x7F,0x7F,0x49,0x5D,0x41,0x63 },    // 'E'37
        { 0x41,0x7F,0x7F,0x49,0x1D,0x01,0x03 },    // 'F'38
        { 0x1C,0x3E,0x63,0x41,0x51,0x73,0x72 },    // 'G'39
        { 0x7F,0x7F,0x08,0x08,0x7F,0x7F,0x00 },    // 'H'40
        { 0x00,0x41,0x7F,0x7F,0x41,0x00,0x00 },    // 'I'41
        { 0x30,0x70,0x40,0x41,0x7F,0x3F,0x01 },    // 'J'42
        { 0x41,0x7F,0x7F,0x08,0x1C,0x77,0x63 },    // 'K'43
        { 0x41,0x7F,0x7F,0x41,0x40,0x60,0x70 },    // 'L'44
        { 0x7F,0x7F,0x0E,0x1C,0x0E,0x7F,0x7F },    // 'M'45
        { 0x7F,0x7F,0x06,0x0C,0x18,0x7F,0x7F },    // 'N'46
        { 0x1C,0x3E,0x63,0x41,0x63,0x3E,0x1C },    // 'O'47
        { 0x41,0x7F,0x7F,0x49,0x09,0x0F,0x06 },    // 'P'48
        { 0x1E,0x3F,0x21,0x71,0x7F,0x5E,0x00 },    // 'Q'49
        { 0x41,0x7F,0x7F,0x09,0x19,0x7F,0x66 },    // 'R'50
        { 0x26,0x6F,0x4D,0x59,0x73,0x32,0x00 },    // 'S'51
        { 0x03,0x41,0x7F,0x7F,0x41,0x03,0x00 },    // 'T'52
        { 0x7F,0x7F,0x40,0x40,0x7F,0x7F,0x00 },    // 'U'53
        { 0x1F,0x3F,0x60,0x60,0x3F,0x1F,0x00 },    // 'V'54
        { 0x7F,0x7F,0x30,0x18,0x30,0x7F,0x7F },    // 'W'55
        { 0x43,0x67,0x3C,0x18,0x3C,0x67,0x43 },    // 'X'56
        { 0x07,0x4F,0x78,0x78,0x4F,0x07,0x00 },    // 'Y'57
        { 0x47,0x63,0x71,0x59,0x4D,0x67,0x73 },    // 'Z'58
        { 0x00,0x7F,0x7F,0x41,0x41,0x00,0x00 },    // '['59
        { 0x01,0x03,0x06,0x0C,0x18,0x30,0x60 },    // '\'60
        { 0x00,0x41,0x41,0x7F,0x7F,0x00,0x00 },    // ']'61
        { 0x08,0x0C,0x06,0x03,0x06,0x0C,0x08 },    // '^'62
        { 0x80,0x80,0x80,0x80,0x80,0x80,0x80 },    // '_'63
        { 0x00,0x00,0x03,0x07,0x04,0x00,0x00 },    // '`'64
        { 0x20,0x74,0x54,0x54,0x3C,0x78,0x40 },    // 'a'65
        { 0x41,0x7F,0x3F,0x48,0x48,0x78,0x30 },    // 'b'66
        { 0x38,0x7C,0x44,0x44,0x6C,0x28,0x00 },    // 'c'67
        { 0x30,0x78,0x48,0x49,0x3F,0x7F,0x40 },    // 'd'68
        { 0x38,0x7C,0x54,0x54,0x5C,0x18,0x00 },    // 'e'69
        { 0x48,0x7E,0x7F,0x49,0x03,0x02,0x00 },    // 'f'70
        { 0x38,0xBC,0xA4,0xA4,0xFC,0x78,0x00 },    // 'g'71
        { 0x41,0x7F,0x7F,0x08,0x04,0x7C,0x78 },    // 'h'72
        { 0x00,0x44,0x7D,0x7D,0x40,0x00,0x00 },    // 'i'73
        { 0x60,0xE0,0x80,0x80,0xFD,0x7D,0x00 },    // 'j'74
        { 0x41,0x7F,0x7F,0x10,0x38,0x6C,0x44 },    // 'k'75
        { 0x00,0x41,0x7F,0x7F,0x40,0x00,0x00 },    // 'l'76
        { 0x78,0x7C,0x1C,0x38,0x1C,0x7C,0x78 },    // 'm'77
        { 0x7C,0x7C,0x04,0x04,0x7C,0x78,0x00 },    // 'n'78
        { 0x38,0x7C,0x44,0x44,0x7C,0x38,0x00 },    // 'o'79
        { 0x00,0xFC,0xFC,0xA4,0x24,0x3C,0x18 },    // 'p'80
        { 0x18,0x3C,0x24,0xA4,0xF8,0xFC,0x84 },    // 'q'81
        { 0x44,0x7C,0x78,0x4C,0x04,0x1C,0x18 },    // 'r'82
        { 0x48,0x5C,0x54,0x54,0x74,0x24,0x00 },    // 's'83
        { 0x00,0x04,0x3E,0x7F,0x44,0x24,0x00 },    // 't'84
        { 0x3C,0x7C,0x40,0x40,0x3C,0x7C,0x40 },    // 'u'85
        { 0x1C,0x3C,0x60,0x60,0x3C,0x1C,0x00 },    // 'v'86
        { 0x3C,0x7C,0x70,0x38,0x70,0x7C,0x3C },    // 'w'87
        { 0x44,0x6C,0x38,0x10,0x38,0x6C,0x44 },    // 'x'88
        { 0x3C,0xBC,0xA0,0xA0,0xFC,0x7C,0x00 },    // 'y'89
        { 0x4C,0x64,0x74,0x5C,0x4C,0x64,0x00 },    // 'z'90
        { 0x08,0x08,0x3E,0x77,0x41,0x41,0x00 },    // '{'91
        { 0x00,0x00,0x00,0x77,0x77,0x00,0x00 },    // '|'92
        { 0x41,0x41,0x77,0x3E,0x08,0x08,0x00 },    // '}'93
        { 0x02,0x03,0x01,0x03,0x02,0x03,0x01 },    // '~'94
        { 0xFF,0x81,0x81,0x81,0x81,0x81,0xFF },    // ''95
        { 0x0E,0x9F,0x91,0xB1,0xFB,0x4A,0x00 },    // '255
};

/* Reverse bits. Used to flip characters. */
static unsigned char reverse(unsigned char b)
{
        b = (b & 0xF0) >> 4 | (b & 0x0F) << 4;
        b = (b & 0xCC) >> 2 | (b & 0x33) << 2;
        b = (b & 0xAA) >> 1 | (b & 0x55) << 1;
        return b;
}

/* Send a command to the LCD. Mode indicates data or instructional command. */
static void send_cmd(unsigned char data, LCDCommandMode mode)
{
        A0 = (int) mode;
        delay_ms(1);
        SpiChnPutC(SPI_CHANNEL, data);
        delay_ms(2);
}

/* Write a string of characters starting at a given page and column. */
void lcd_write_string(char *data, unsigned char page, unsigned char col)
{
#ifdef USE_LCD
        int i, c;

        send_cmd(SET_PAGE_ADDRESS(page), CMD_MODE);
        send_cmd(SET_COL_ADDRESS_MSB(col), CMD_MODE);
        send_cmd(SET_COL_ADDRESS_LSB(col), CMD_MODE);

        while (*data != '\0') {
                for(i=0; i<7; i++) {
                        // Character set is flipped - reverse the bits.
                        c = *data - 32;
                        send_cmd(reverse(characters[c][i]), DATA_MODE);
                }
                data++;
        }
#endif
}

/* Write a full bitmap to the screen. */
void lcd_write_bitmap(unsigned char * lcd_string)
{
#ifdef USE_LCD
        unsigned int i, j;
        unsigned char page = 0xB0;

        send_cmd(LCD_DISPLAY_OFF, CMD_MODE);
        send_cmd(SET_START_LINE(0), CMD_MODE);

        for (i=0; i<LCD_NUM_PAGES; i++) {
                send_cmd(SET_PAGE_ADDRESS(page), CMD_MODE);
                send_cmd(SET_COL_ADDRESS_MSB(0), CMD_MODE);
                send_cmd(SET_COL_ADDRESS_LSB(0), CMD_MODE);

                for (j=0; j<LCD_NUM_COLS; j++) {
                        send_cmd(*lcd_string, DATA_MODE);
                        lcd_string++;
                }
                page++;
        }
        send_cmd(LCD_DISPLAY_ON, CMD_MODE);
#endif
}

/* Clear the screen by writing a space to every character slot. */
void lcd_clear(void)
{
#ifdef USE_LCD
        int i;
        char blnk[] = "                   ";  // 128 pxls/7 pxls per char ~ 19

        send_cmd(LCD_DISPLAY_OFF, CMD_MODE);
        for (i=0; i<LCD_NUM_PAGES; i++)
                lcd_write_string(blnk, i, 0);
        send_cmd(LCD_DISPLAY_ON, CMD_MODE);
#endif
}

/* Turn on and initialize the LCD screen. */
void lcd_init(void)
{
#ifdef USE_LCD
        RST = 0;
        delay_ms(5);
        RST = 1;
        delay_ms(5);

        send_cmd(0xA0, CMD_MODE); //RAM->SEG output = normal
        send_cmd(0xAE, CMD_MODE); //Display OFF
        send_cmd(0xC0, CMD_MODE); //COM scan direction = normal
        send_cmd(0xA2, CMD_MODE); //1/9 bias
        send_cmd(0x2F, CMD_MODE); //power control set
        send_cmd(0x21, CMD_MODE); //resistor ratio set
        send_cmd(0x81, CMD_MODE); //Electronic volume command (set contrast)
        send_cmd(0x2F, CMD_MODE); //Electronic volume value (contrast value)
#endif
}

/* Turn on display with battery, cellular, and tag read information. */
void lcd_init_display(void)
{
#ifdef USE_LCD
        lcd_clear();
        send_cmd(LCD_DISPLAY_OFF, CMD_MODE);
        lcd_write_string("battery: ", 3, 0);
        lcd_write_string("tags read: ", 2, 0);
        lcd_write_string("cellular: ", 1, 0);
        lcd_write_string("status: ", 0, 0);
        send_cmd(LCD_DISPLAY_ON, CMD_MODE);
#endif
}

/* Configure SPI communication on the PIC. */
void lcd_init_spi(void)
{
#ifdef USE_LCD
        SpiChnOpen(SPI_CHANNEL, SPI_OPEN_MSTEN | SPI_OPEN_DISSDI, 4);
#endif
}

/* Set the battery status message. */
void lcd_set_battery(BatteryMessage msg)
{
#ifdef USE_LCD
        char s[4];
        switch(msg) {
                case BATTERY_OK:  strcpy(s, "OK "); break;
                case BATTERY_LOW: strcpy(s, "LOW"); break;
                default:          strcpy(s, "   ");
        }
        lcd_write_string(s, 3, 63);
#endif
}

/* Set the cell reception message. */
void lcd_set_cellular(CellularMessage msg)
{
#ifdef USE_LCD
        char s[5];
        switch(msg) {
                case CELLULAR_OK:      strcpy(s, "OK  "); break;
                case CELLULAR_FAILED:  strcpy(s, "FAIL"); break;
                case CELLULAR_PENDING: strcpy(s, "PEND"); break;
                case CELLULAR_LOW:     strcpy(s, "LOW "); break;
                default:               strcpy(s, "    ");
        }
        lcd_write_string(s, 1, 70);
#endif
}

/* Set the number of tags read message. */
void lcd_set_tags(int n)
{
#ifdef USE_LCD
        char s[6];
        sprintf(s, "%5d", n);
        lcd_write_string(s, 2, 77);
#endif
}

/* Set the overall status of the reader. */
void lcd_set_status(StatusMessage msg)
{
#ifdef USE_LCD
        char s[9];
        switch(msg) {
                case STAT_BOOTING:  strcpy(s, "BOOTING "); break;
                case STAT_READY:    strcpy(s, "READY   "); break;
                case STAT_SHUTDOWN: strcpy(s, "SHUTDOWN"); break;
                default:            strcpy(s, "        ");
        }
        lcd_write_string(s, 0, 56);
#endif
}